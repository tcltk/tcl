# This Makefile is used to create several test cases for Tcl's load
# command.  It also illustrates how to take advantage of configuration
# exported by Tcl to set up Makefiles for shared libraries.

CC = @CC@
LIBS =			@TCL_BUILD_STUB_LIB_SPEC@
AC_FLAGS =		@DEFS@
SHLIB_LD =		@SHLIB_LD@
SHLIB_CFLAGS =		@SHLIB_CFLAGS@
SHLIB_LD_LIBS =		@SHLIB_LD_LIBS@
SHLIB_SUFFIX =		@SHLIB_SUFFIX@
DLTEST_LD =		@DLTEST_LD@
SRC_DIR =		@TCL_SRC_DIR@/win/dltest
BUILD_DIR =		@builddir@
NATIVE_ZIP =		@ZIP_PROG@
TCL_VERSION =		@TCL_VERSION@

CFLAGS_DEBUG		= @CFLAGS_DEBUG@
CFLAGS_OPTIMIZE		= @CFLAGS_OPTIMIZE@
CFLAGS			= @CFLAGS_DEFAULT@ @CFLAGS@ -DTCL_NO_DEPRECATED=1 -Wall -Wextra -Wc++-compat -Wconversion -Werror
LDFLAGS_DEBUG		= @LDFLAGS_DEBUG@
LDFLAGS_OPTIMIZE	= @LDFLAGS_OPTIMIZE@
LDFLAGS			= @LDFLAGS_DEFAULT@ @LDFLAGS@ -static-libgcc

CC_SWITCHES = $(CFLAGS) -I${SRC_DIR}/../../generic \
	${SHLIB_CFLAGS} -DUSE_TCL_STUBS ${AC_FLAGS}

all: memorymoduletest.zip

memorymoduletest.zip:	tcl9memorymoduletest${SHLIB_SUFFIX} tcl9threadvartest${SHLIB_SUFFIX} tcl9threadvar2test${SHLIB_SUFFIX}
	@if test -n "${NATIVE_ZIP}"; then \
	  if test -f ../minizip.exe; then \
	    cp ../minizip.exe . ; \
	  fi; \
	(zip=`(realpath '${NATIVE_ZIP}' || readlink -m '${NATIVE_ZIP}') 2>/dev/null || \
	  (echo '${NATIVE_ZIP}' | sed "s?^\./?$$(pwd)/?")`; \
	  $$zip memorymoduletest.zip pkgIndex.tcl *${SHLIB_SUFFIX} >/dev/null && \
	  echo "memorymoduletest.zip successful created with $$zip" \
	); \
	fi

memorymoduletest.o: $(SRC_DIR)/memorymoduletest.c
	$(CC) -c $(CC_SWITCHES) $(SRC_DIR)/memorymoduletest.c

threadvartest.o: $(SRC_DIR)/threadvartest.c
	$(CC) -c $(CC_SWITCHES) $(SRC_DIR)/threadvartest.c

threadvar2test.o: $(SRC_DIR)/threadvar2test.c
	$(CC) -c $(CC_SWITCHES) $(SRC_DIR)/threadvar2test.c

tcl9memorymoduletest${SHLIB_SUFFIX}: memorymoduletest.o
	${SHLIB_LD} -o $@ memorymoduletest.o ${SHLIB_LD_LIBS}

tcl9threadvartest${SHLIB_SUFFIX}: threadvartest.o
	${SHLIB_LD} -o $@ threadvartest.o ${SHLIB_LD_LIBS}

tcl9threadvar2test${SHLIB_SUFFIX}: threadvar2test.o
	${SHLIB_LD} -o $@ threadvar2test.o ${SHLIB_LD_LIBS}

clean:
	rm -f embtest *.o lib.exp ../dltest.marker
	@if test "$(SHLIB_SUFFIX)" != ""; then \
	    echo "rm -f *${SHLIB_SUFFIX}" ; \
	    rm -f *${SHLIB_SUFFIX} ; \
	fi

distclean: clean
	rm -f Makefile
